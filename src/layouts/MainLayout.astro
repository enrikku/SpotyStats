---
import "../styles/global.css";
import Analytics from "@vercel/analytics/astro";
import SpeedInsights from "@vercel/speed-insights/astro";
import Footer from "../components/Footer.astro";
import NavBar from "../components/NavBar.astro";

interface Props {
  content: {
    title: string;
  };
}

const { content } = Astro.props;
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{content.title}</title>
  </head>
  <body>
    <div class="min-h-screen flex flex-col">
      <main class="grow">
        <NavBar />
        <slot />
      </main>
      <Footer />
    </div>
    <Analytics />
    <SpeedInsights />
    <script>
      import { getCookieValue, saveCookie, deleteCookie } from "../utils/utils";

      document.addEventListener("DOMContentLoaded", () => {
        loadProfile();

      });
      
      async function loadProfile() {
        const avatar = document.getElementById("avatar") as HTMLImageElement;
        let profile = null;
        var cookieheader = document.cookie;
        const cookieDisplayName = getCookieValue(cookieheader, "display_name");
        const cookieAvatar = getCookieValue(cookieheader, "avatar");

        if (cookieDisplayName && cookieAvatar) {
          console.log("Using profile from cookies");

          avatar.src = cookieAvatar;
        } else {
          try {
            const res = await fetch("/api/spotify/profile");
            profile = await res.json();
          } catch {
            profile = null;
          }
          console.log("Profile in layout:", profile);
        }

        // If profile is not null, save display_name and avatar to cookies
        if (profile !== null) {
          saveCookie("display_name", profile.display_name, 3600);
          saveCookie("avatar", profile.images?.[0]?.url || "", 3600);

          avatar.src = profile.images?.[0]?.url || "";
        }
      }

      // import { decrypt } from "../lib/crypto.js";
      // import { getAccesTokenCookie } from "../lib/utils.js";

      // function getCookie(name: string) {
      //   const value = `; ${document.cookie}`;
      //   const parts = value.split(`; ${name}=`);
      //   if (parts.length >= 2) {
      //     const cookieValue = parts.pop().split(";").shift();
      //     return cookieValue ? decodeURIComponent(cookieValue) : "";
      //   }
      //   return "";
      // }

      // function setCookie(name: string, value: string, seconds: number = 3600) {
      //   const expires = new Date(Date.now() + seconds * 1000).toUTCString();
      //   document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
      // }

      // //#region "Load Profile"
      // const token = await getAccesTokenCookie();

      // console.log("token", token);

      // // if (!token) {
      // //   window.location.href = "/";
      // // }

      // var name = "";
      // var urlImage = "";
      // var externalUrl = "";

      // const cookieDisplayName = getCookie("display_name");
      // const cookieAvatar = getCookie("avatar");
      // const cookieExternalUrls = getCookie("external_urls");

      // if (cookieDisplayName && cookieAvatar && cookieExternalUrls) {
      //   name = cookieDisplayName;
      //   urlImage = cookieAvatar;
      //   externalUrl = cookieExternalUrls;
      // } else {
      //   const res = await fetch("https://api.spotify.com/v1/me", {
      //     headers: {
      //       Authorization: `Bearer ${token}`,
      //     },
      //   });

      //   if (res.ok) {
      //     const user = await res.json();
      //     urlImage = user.images?.[0]?.url || "";

      //     setCookie("display_name", user.display_name, 3600);
      //     setCookie("external_urls", user.external_urls, 3600);
      //     setCookie("avatar", user.images?.[0]?.url, 3600);
      //   } else {
      //     console.error("âŒ Error al obtener perfil:", res.status);
      //     console.log(res);
      //   }
      // }

      // const avatar = document.getElementById("avatar") as HTMLImageElement;
      // avatar.src = urlImage;
      // //#endregion

      // const logout = document.getElementById("logout");
      // if (logout) {
      //   logout.addEventListener("click", () => {
      //     const cookies = document.cookie.split(";");

      //     for (const cookie of cookies) {
      //       const name = cookie.split("=")[0].trim();
      //       document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
      //     }
      //     window.location.href = "/";
      //   });
      // }
    </script>
  </body>
</html>
